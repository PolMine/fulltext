---
title: "Introducing 'fulltext'"
author: "Andreas Blätte (andreas.blaette@uni-due.de)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{annolite}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

## Purpose

The ´fulltext´-package includes a lightweight htmlwidget for fulltext output.


## Getting Started

```{r, eval = FALSE}
library(janeaustenr)
library(tokenizers)
library(annolite)
```

## From tidytext to fulltext

```{r, eval = FALSE}
emma_txt <- janeaustenr::emma[grep("^CHAPTER\\s+.*?$", janeaustenr::emma)[1]:length(janeaustenr::emma)]
chapter_beginnings <- grep("^CHAPTER\\s+.*?$", emma_txt)
chapters <- split(
  emma_txt,
  cut(
    1L:length(emma_txt),
    c(chapter_beginnings, length(emma_txt)),
    include.lowest = TRUE, right = FALSE
  )
)

reconstruct_paragraphs <- function(x){
  paras <- split(
    x, 
    cut(
      1L:length(x),
      unique(c(1L, grep("^\\s*$", x), length(x))),
      include.lowest = TRUE, right = FALSE
    )
  )
  paras <- lapply(paras, function(x) x[x != ""])
  for (i in rev(which(lapply(paras, length) == 0))) paras[[i]] <- NULL
  sapply(paras, function(p) paste(p, collapse = " "))
}

chs <- lapply(chapters, reconstruct_paragraphs)

as_paragraphdata <- function(x){
  paras_tok <- tokenizers::tokenize_words(x, lowercase = FALSE, strip_punct = FALSE)
  df1 <- lapply(
    1:length(paras_tok),
    function(i) data.frame(token = paras_tok[[i]], para = i)
  )
  df2 <- do.call(rbind, df1)
  df2[["id"]] <- 1L:nrow(df2)
  para_list <- split(df2, f = df2[["para"]])
  
  lapply(
    para_list,
    function(x) list(element = "p", tokenstream = x[, c("id", "token")])
  )
}

ch1_paragraphs <- as_paragraphdata(chs[[1]])
ch1_paragraphs[[1]][["element"]] <- "h3"
ch1_paragraphs <- c(
  list(list(
    element = "h2",
    tokenstream = data.frame(token = c("Jane", "Austen", "-", "Emma"), id = 10001L:10004L)
    )),
  ch1_paragraphs
)
ch1_fulltextdata <- list(
  paragraphs = ch1_paragraphs,
  annotations = data.frame(
      text = character(),
      code = character(),
      annotation = character(),
      id_left = integer(),
      id_right = integer()
  )
)
```

```{r, eval = FALSE}
fulltext(ch1_fulltextdata, dialog = FALSE, box = TRUE, width = 650)
```


## Initialization

We introduce the fulltext package by example. In addition to the fulltext package, we need the polmineR package which includes the GERMAPARLMINI corpus.

```{r, eval = FALSE}
library(annolite)
library(polmineR)
use("polmineR")
```


## The speech to reconstruct

The example aims at outputting one particular speech. We take a speech held by Voker Kauder in the German Bundestag.

```{r, eval = FALSE}
P <- partition("GERMAPARLMINI", speaker = "Volker Kauder", date = "2009-11-10")
```


## Input data for the widget

The data that is passed to the JavaScript that generates the output. Expected to be a list of lists that provide data on sections of text. Each of the sub-lists is to be a named list of a character vector with the HTML element the section will be wrapped into, and  a `data.frame` (or a list) with a column "token", and a column "id".

```{r, eval = FALSE}
D <- as.fulltextdata(P, headline = "Volker Kauder (CDU)")
```


## Adding a headline


## Getting the output

```{r, eval = FALSE}
fulltext(D, dialog = FALSE, box = TRUE, width = 650)
```

## Perspectives

Enjoy! 